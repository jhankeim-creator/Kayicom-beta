import { useState, useEffect, useCallback, useMemo, startTransition } from 'react';
import { axiosInstance } from '../App';
import Navbar from '../components/Navbar';
import Footer from '../components/Footer';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Save, Settings as SettingsIcon, Key, Package, Mail, Plus, X } from 'lucide-react';
import { toast } from 'sonner';

const AdminSettings = ({ user, logout, settings: currentSettings, loadSettings }) => {
  const [loading, setLoading] = useState(false);
  const [uploadingLogo, setUploadingLogo] = useState(false);
  const [formData, setFormData] = useState({
    site_name: '',
    logo_url: '',
    primary_color: '',
    secondary_color: '',
    support_email: '',
    plisio_api_key: '',
    mtcgame_api_key: '',
    gosplit_api_key: '',
    z2u_api_key: '',
    resend_api_key: '',
    resend_from_email: '',
    trustpilot_enabled: false,
    trustpilot_business_id: '',
    product_categories: [],
    payment_gateways: {
      paypal: { enabled: true, email: '', instructions: '' },
      airtm: { enabled: true, email: '', instructions: '' },
      skrill: { enabled: true, email: '', instructions: '' },
      moncash: { enabled: true, email: '', instructions: '' },
      binance_pay: { enabled: true, email: '', instructions: '' },
      zelle: { enabled: true, email: '', instructions: '' },
      cashapp: { enabled: true, email: '', instructions: '' }
    },
    crypto_settings: {
      buy_rate_usdt: 1.0,
      sell_rate_usdt: 0.98,
      transaction_fee_percent: 2.0,
      min_transaction_usd: 10.0,
      wallets: { BEP20: '', TRC20: '', MATIC: '' }
    }
  });
  const [newCategory, setNewCategory] = useState('');
  const [bulkEmail, setBulkEmail] = useState({
    subject: '',
    message: '',
    recipient_type: 'all'
  });
  const [sendingEmail, setSendingEmail] = useState(false);

  const defaultPaymentGateways = useMemo(() => ({
    paypal: { enabled: true, email: '', instructions: '' },
    airtm: { enabled: true, email: '', instructions: '' },
    skrill: { enabled: true, email: '', instructions: '' },
    moncash: { enabled: true, email: '', instructions: '' },
    binance_pay: { enabled: true, email: '', instructions: '' },
    zelle: { enabled: true, email: '', instructions: '' },
    cashapp: { enabled: true, email: '', instructions: '' }
  }), []);

  useEffect(() => {
    if (currentSettings) {
      startTransition(() => {
        setFormData({
          site_name: currentSettings.site_name || '',
          logo_url: currentSettings.logo_url || '',
          primary_color: currentSettings.primary_color || '',
          secondary_color: currentSettings.secondary_color || '',
          support_email: currentSettings.support_email || '',
          plisio_api_key: currentSettings.plisio_api_key || '',
          mtcgame_api_key: currentSettings.mtcgame_api_key || '',
          gosplit_api_key: currentSettings.gosplit_api_key || '',
          z2u_api_key: currentSettings.z2u_api_key || '',
          resend_api_key: currentSettings.resend_api_key || '',
          resend_from_email: currentSettings.resend_from_email || '',
          trustpilot_enabled: currentSettings.trustpilot_enabled || false,
          trustpilot_business_id: currentSettings.trustpilot_business_id || '',
          product_categories: currentSettings.product_categories || ['giftcard', 'topup', 'subscription', 'service'],
          payment_gateways: currentSettings.payment_gateways || defaultPaymentGateways,
          crypto_settings: currentSettings.crypto_settings || {
            buy_rate_usdt: 1.0,
            sell_rate_usdt: 0.98,
            transaction_fee_percent: 2.0,
            min_transaction_usd: 10.0,
            wallets: { BEP20: '', TRC20: '', MATIC: '' }
          }
        });
      });
    }
  }, [currentSettings, defaultPaymentGateways]);

  const addCategory = useCallback(() => {
    setFormData(prev => {
      if (newCategory && !prev.product_categories.includes(newCategory)) {
        setNewCategory('');
        return {...prev, product_categories: [...prev.product_categories, newCategory]};
      }
      return prev;
    });
  }, [newCategory]);

  const removeCategory = useCallback((cat) => {
    setFormData(prev => ({...prev, product_categories: prev.product_categories.filter(c => c !== cat)}));
  }, []);

  const handleSendBulkEmail = async () => {
    if (!bulkEmail.subject || !bulkEmail.message) {
      toast.error('Please fill in subject and message');
      return;
    }

    setSendingEmail(true);
    try {
      const response = await axiosInstance.post('/emails/bulk-send', bulkEmail);
      toast.success(`Email sent to ${response.data.sent_count} recipients!`);
      setBulkEmail({subject: '', message: '', recipient_type: 'all'});
    } catch (error) {
      toast.error(error.response?.data?.detail || 'Error sending bulk email');
    } finally {
      setSendingEmail(false);
    }
  };

  const uploadLogo = async (file) => {
    if (!file) return null;
    if (file.size > 5 * 1024 * 1024) {
      toast.error('File too large. Max 5MB');
      return null;
    }

    setUploadingLogo(true);
    try {
      const data = new FormData();
      data.append('file', file);
      const res = await axiosInstance.post('/upload/image', data, {
        headers: { 'Content-Type': 'multipart/form-data' }
      });
      return res.data?.url || null;
    } catch (e) {
      console.error('Logo upload failed:', e);
      toast.error('Error uploading logo');
      return null;
    } finally {
      setUploadingLogo(false);
    }
  };

  const handleChange = useCallback((field, value) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  }, []);

  const handlePaymentGatewayChange = useCallback((gateway, field, value) => {
    setFormData(prev => {
      // Ensure payment_gateways exists
      if (!prev.payment_gateways) return prev;
      
      return {
        ...prev,
        payment_gateways: {
          ...prev.payment_gateways,
          [gateway]: {
            ...(prev.payment_gateways[gateway] || {}),
            [field]: value
          }
        }
      };
    });
  }, []);

  const handleCryptoSettingsChange = useCallback((field, value) => {
    setFormData(prev => ({
      ...prev,
      crypto_settings: {
        ...(prev.crypto_settings || {}),
        [field]: value
      }
    }));
  }, []);

  const handleCryptoWalletChange = useCallback((chain, value) => {
    setFormData(prev => ({
      ...prev,
      crypto_settings: {
        ...(prev.crypto_settings || {}),
        wallets: {
          ...((prev.crypto_settings || {}).wallets || {}),
          [chain]: value
        }
      }
    }));
  }, []);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);

    try {
      const updates = {};
      Object.keys(formData).forEach(key => {
        // Include all fields except empty strings (but keep false booleans)
        if (formData[key] !== '' && formData[key] !== undefined) {
          updates[key] = formData[key];
        }
      });

      await axiosInstance.put('/settings', updates);
      toast.success('Settings saved successfully!');
      await loadSettings();
    } catch (error) {
      console.error('Error saving settings:', error);
      toast.error('Error saving settings');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen gradient-bg">
      <Navbar user={user} logout={logout} cartItemCount={0} settings={currentSettings} />

      <div className="container mx-auto px-4 py-12">
        <div className="max-w-4xl mx-auto">
          <div className="flex justify-between items-center mb-6">
            <h1 className="text-3xl font-bold text-white" data-testid="settings-title">Site Settings</h1>
            <Button 
              onClick={() => window.location.href = '/admin'}
              className="bg-gradient-to-r from-pink-500 to-blue-500 text-white px-6 py-3"
            >
              üè† Admin Home
            </Button>
          </div>

          <Card className="glass-effect border-white/20">
            <CardContent className="p-6">
              <Tabs defaultValue="general" className="w-full">
                <TabsList className="grid w-full grid-cols-2 lg:grid-cols-6 mb-6">
                  <TabsTrigger value="general" data-testid="tab-general">
                    <SettingsIcon size={16} className="mr-2" />
                    General
                  </TabsTrigger>
                  <TabsTrigger value="api" data-testid="tab-api">
                    <Key size={16} className="mr-2" />
                    API Keys
                  </TabsTrigger>
                  <TabsTrigger value="integrations" data-testid="tab-integrations">
                    <Package size={16} className="mr-2" />
                    Integrations
                  </TabsTrigger>
                  <TabsTrigger value="payments" data-testid="tab-payments">
                    <Key size={16} className="mr-2" />
                    Payments
                  </TabsTrigger>
                  <TabsTrigger value="categories" data-testid="tab-categories">
                    <Package size={16} className="mr-2" />
                    Categories
                  </TabsTrigger>
                  <TabsTrigger value="email" data-testid="tab-email">
                    <Mail size={16} className="mr-2" />
                    Bulk Email
                  </TabsTrigger>
                </TabsList>

                <form onSubmit={handleSubmit}>
                  <TabsContent value="general" className="space-y-4">
                    <div>
                      <Label htmlFor="site_name" className="text-white">Site Name</Label>
                      <Input
                        id="site_name"
                        value={formData.site_name}
                        onChange={(e) => handleChange('site_name', e.target.value)}
                        className="bg-white/10 border-white/20 text-white placeholder:text-white/50"
                        data-testid="site-name-input"
                      />
                    </div>

                    <div>
                      <Label htmlFor="support_email" className="text-white">Support Email</Label>
                      <Input
                        id="support_email"
                        type="email"
                        value={formData.support_email}
                        onChange={(e) => handleChange('support_email', e.target.value)}
                        className="bg-white/10 border-white/20 text-white placeholder:text-white/50"
                        data-testid="support-email-input"
                      />
                    </div>

                    <div>
                      <Label htmlFor="logo_url" className="text-white">Logo URL</Label>
                      <Input
                        id="logo_url"
                        value={formData.logo_url}
                        onChange={(e) => handleChange('logo_url', e.target.value)}
                        className="bg-white/10 border-white/20 text-white placeholder:text-white/50"
                        placeholder="https://example.com/logo.png"
                        data-testid="logo-url-input"
                      />
                      <div className="mt-3">
                        <Label htmlFor="logo_file" className="text-white">Or Upload Logo</Label>
                        <Input
                          id="logo_file"
                          type="file"
                          accept="image/*"
                          disabled={uploadingLogo}
                          onChange={async (e) => {
                            const file = e.target.files?.[0];
                            const url = await uploadLogo(file);
                            if (url) {
                              handleChange('logo_url', url);
                              toast.success('Logo uploaded');
                            }
                          }}
                          className="bg-white/10 border-white/20 text-white cursor-pointer mt-2"
                        />
                        {uploadingLogo && (
                          <p className="text-white/60 text-sm mt-2">Uploading...</p>
                        )}
                      </div>
                      {formData.logo_url && (
                        <div className="mt-2">
                          <img src={formData.logo_url} alt="Logo preview" className="h-16 bg-white/10 p-2 rounded" />
                        </div>
                      )}
                    </div>
                  </TabsContent>

                  <TabsContent value="api" className="space-y-4">
                    <div>
                      <Label htmlFor="plisio_api_key" className="text-white">Plisio API Key (Crypto Payment)</Label>
                      <Input
                        id="plisio_api_key"
                        type="password"
                        value={formData.plisio_api_key}
                        onChange={(e) => handleChange('plisio_api_key', e.target.value)}
                        className="bg-white/10 border-white/20 text-white placeholder:text-white/50"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        data-testid="plisio-key-input"
                      />
                    </div>

                    <div>
                      <Label htmlFor="resend_api_key" className="text-white">Resend API Key (Email)</Label>
                      <Input
                        id="resend_api_key"
                        type="password"
                        value={formData.resend_api_key}
                        onChange={(e) => handleChange('resend_api_key', e.target.value)}
                        className="bg-white/10 border-white/20 text-white placeholder:text-white/50"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        data-testid="resend-key-input"
                      />
                    </div>
                    
                    <div>
                      <Label htmlFor="resend_from_email" className="text-white">Resend From Email</Label>
                      <Input
                        id="resend_from_email"
                        value={formData.resend_from_email}
                        onChange={(e) => handleChange('resend_from_email', e.target.value)}
                        className="bg-white/10 border-white/20 text-white placeholder:text-white/50"
                        placeholder='Example: "KayiCom <no-reply@yourdomain.com>"'
                      />
                      <p className="text-white/50 text-xs mt-1">
                        This must be a verified sender/domain in Resend; otherwise sending will fail.
                      </p>
                    </div>

                    <div className="p-4 bg-blue-400/10 border border-blue-400/30 rounded-lg mt-4">
                      <p className="text-blue-200 text-sm">
                        <strong>Note:</strong> API keys are encrypted and used for automation.
                      </p>
                    </div>
                  </TabsContent>

                  {/* Integrations Tab */}
                  <TabsContent value="integrations" className="space-y-6">
                    <div>
                      <h3 className="text-xl font-bold text-white mb-4">Trustpilot Reviews</h3>
                      <p className="text-gray-400 mb-6">Add a link to your Trustpilot reviews page in the website footer.</p>
                      
                      {/* Enable Trustpilot */}
                      <div className="bg-white/5 p-4 rounded-lg mb-4">
                        <div className="flex justify-between items-center mb-3">
                          <div>
                            <h4 className="text-white font-semibold flex items-center gap-2">
                              ‚≠ê Trustpilot Link
                            </h4>
                            <p className="text-white/60 text-sm mt-1">Show Trustpilot reviews button in footer</p>
                          </div>
                          <label className="flex items-center gap-2">
                            <input 
                              type="checkbox" 
                              checked={formData.trustpilot_enabled}
                              onChange={(e) => handleChange('trustpilot_enabled', e.target.checked)}
                              className="w-4 h-4" 
                            />
                            <span className="text-white text-sm">Enabled</span>
                          </label>
                        </div>
                        
                        {formData.trustpilot_enabled && (
                          <div className="space-y-3 mt-4">
                            <div>
                              <Label className="text-white/70 text-sm">Trustpilot Business ID</Label>
                              <Input
                                placeholder="kayicom.com"
                                value={formData.trustpilot_business_id}
                                onChange={(e) => handleChange('trustpilot_business_id', e.target.value)}
                                className="bg-white/10 border-white/20 text-white mt-1"
                              />
                              <p className="text-white/50 text-xs mt-1">
                                Example: kayicom.com (from URL: https://fr.trustpilot.com/review/<strong>kayicom.com</strong>)
                              </p>
                            </div>
                          </div>
                        )}
                      </div>
                      
                      <div className="p-4 bg-green-400/10 border border-green-400/30 rounded-lg">
                        <p className="text-green-200 text-sm">
                          <strong>Note:</strong> After enabling, a button linking to your Trustpilot reviews will appear in the footer. Customers can click to see your actual reviews on Trustpilot.
                        </p>
                      </div>
                    </div>
                  </TabsContent>

                  <TabsContent value="categories" className="space-y-4">
                    <div>
                      <Label className="text-white text-lg font-semibold mb-3 block">Product Categories</Label>
                      <p className="text-gray-400 text-sm mb-4">Manage product categories for your marketplace.</p>
                      
                      <div className="flex gap-2 mb-4">
                        <Input
                          value={newCategory}
                          onChange={(e) => setNewCategory(e.target.value)}
                          className="flex-1 bg-white/10 border-white/20 text-white placeholder:text-gray-500"
                          placeholder="Enter new category"
                          data-testid="new-category-input"
                        />
                        <Button onClick={addCategory} type="button" className="gradient-button text-white" data-testid="add-category-btn">
                          <Plus size={16} className="mr-1" />
                          Add
                        </Button>
                      </div>

                      <div className="space-y-2">
                        {formData.product_categories.map((cat, index) => (
                          <div key={index} className="flex items-center justify-between p-3 glass-effect rounded-lg" data-testid={`category-${cat}`}>
                            <span className="text-white font-medium capitalize">{cat}</span>
                            <Button
                              type="button"
                              size="sm"
                              variant="ghost"
                              onClick={() => removeCategory(cat)}
                              className="text-red-400 hover:text-red-300 hover:bg-red-400/10"
                              data-testid={`remove-${cat}`}
                            >
                              <X size={16} />
                            </Button>
                          </div>
                        ))}
                      </div>
                    </div>
                  </TabsContent>


                  {/* Payment Gateways Tab */}
                  <TabsContent value="payments" className="space-y-6">
                    {formData.payment_gateways ? (
                    <div>
                      <h3 className="text-xl font-bold text-white mb-4">Payment Gateway Configuration</h3>
                      <p className="text-gray-400 mb-6">Configure payment methods, wallets, and instructions for customers.</p>
                      
                      {/* PayPal */}
                      <div className="bg-white/5 p-4 rounded-lg mb-4">
                        <div className="flex justify-between items-center mb-3">
                          <h4 className="text-white font-semibold flex items-center gap-2">
                            <span>üí≥</span> PayPal
                          </h4>
                          <label className="flex items-center gap-2">
                            <input 
                              type="checkbox" 
                              checked={formData.payment_gateways?.paypal?.enabled || false}
                              onChange={(e) => handlePaymentGatewayChange('paypal', 'enabled', e.target.checked)}
                              className="w-4 h-4" 
                            />
                            <span className="text-white text-sm">Enabled</span>
                          </label>
                        </div>
                        <div className="space-y-2">
                          <div>
                            <Label className="text-white/70 text-sm">PayPal Email</Label>
                            <Input
                              placeholder="your@paypal.com"
                              value={formData.payment_gateways?.paypal?.email || ""}
                              onChange={(e) => handlePaymentGatewayChange('paypal', 'email', e.target.value)}
                              className="bg-white/10 border-white/20 text-white mt-1"
                            />
                          </div>
                          <div>
                            <Label className="text-white/70 text-sm">Instructions for Customers</Label>
                            <Textarea
                              placeholder="Send payment to the email above with order ID in notes"
                              value={formData.payment_gateways?.paypal?.instructions || ""}
                              onChange={(e) => handlePaymentGatewayChange('paypal', 'instructions', e.target.value)}
                              className="bg-white/10 border-white/20 text-white mt-1"
                              rows={2}
                            />
                          </div>
                        </div>
                      </div>

                      {/* AirTM */}
                      <div className="bg-white/5 p-4 rounded-lg mb-4">
                        <div className="flex justify-between items-center mb-3">
                          <h4 className="text-white font-semibold flex items-center gap-2">
                            <span>üí∏</span> AirTM
                          </h4>
                          <label className="flex items-center gap-2">
                            <input 
                              type="checkbox" 
                              checked={formData.payment_gateways?.airtm?.enabled || false}
                              onChange={(e) => handlePaymentGatewayChange('airtm', 'enabled', e.target.checked)}
                              className="w-4 h-4" 
                            />
                            <span className="text-white text-sm">Enabled</span>
                          </label>
                        </div>
                        <div className="space-y-2">
                          <div>
                            <Label className="text-white/70 text-sm">AirTM Email/Username</Label>
                            <Input
                              placeholder="your@email.com"
                              value={formData.payment_gateways?.airtm?.email || ""}
                              onChange={(e) => handlePaymentGatewayChange('airtm', 'email', e.target.value)}
                              className="bg-white/10 border-white/20 text-white mt-1"
                            />
                          </div>
                          <div>
                            <Label className="text-white/70 text-sm">Instructions</Label>
                            <Textarea
                              placeholder="Send via AirTM to the email above"
                              value={formData.payment_gateways?.airtm?.instructions || ""}
                              onChange={(e) => handlePaymentGatewayChange('airtm', 'instructions', e.target.value)}
                              className="bg-white/10 border-white/20 text-white mt-1"
                              rows={2}
                            />
                          </div>
                        </div>
                      </div>

                      {/* Skrill */}
                      <div className="bg-white/5 p-4 rounded-lg mb-4">
                        <div className="flex justify-between items-center mb-3">
                          <h4 className="text-white font-semibold flex items-center gap-2">
                            <span>üí∞</span> Skrill
                          </h4>
                          <label className="flex items-center gap-2">
                            <input 
                              type="checkbox" 
                              checked={formData.payment_gateways?.skrill?.enabled || false}
                              onChange={(e) => handlePaymentGatewayChange('skrill', 'enabled', e.target.checked)}
                              className="w-4 h-4" 
                            />
                            <span className="text-white text-sm">Enabled</span>
                          </label>
                        </div>
                        <div className="space-y-2">
                          <div>
                            <Label className="text-white/70 text-sm">Skrill Email</Label>
                            <Input
                              placeholder="your@skrill.com"
                              value={formData.payment_gateways?.skrill?.email || ""}
                              onChange={(e) => handlePaymentGatewayChange('skrill', 'email', e.target.value)}
                              className="bg-white/10 border-white/20 text-white mt-1"
                            />
                          </div>
                          <div>
                            <Label className="text-white/70 text-sm">Instructions</Label>
                            <Textarea
                              placeholder="Send to Skrill email above"
                              value={formData.payment_gateways?.skrill?.instructions || ""}
                              onChange={(e) => handlePaymentGatewayChange('skrill', 'instructions', e.target.value)}
                              className="bg-white/10 border-white/20 text-white mt-1"
                              rows={2}
                            />
                          </div>
                        </div>
                      </div>

                      {/* MonCash */}
                      <div className="bg-white/5 p-4 rounded-lg mb-4">
                        <div className="flex justify-between items-center mb-3">
                          <h4 className="text-white font-semibold flex items-center gap-2">
                            <span>üíµ</span> MonCash
                          </h4>
                          <label className="flex items-center gap-2">
                            <input 
                              type="checkbox" 
                              checked={formData.payment_gateways?.moncash?.enabled || false}
                              onChange={(e) => handlePaymentGatewayChange('moncash', 'enabled', e.target.checked)}
                              className="w-4 h-4" 
                            />
                            <span className="text-white text-sm">Enabled</span>
                          </label>
                        </div>
                        <div className="space-y-2">
                          <div>
                            <Label className="text-white/70 text-sm">MonCash Number</Label>
                            <Input
                              placeholder="+509XXXXXXXX"
                              value={formData.payment_gateways?.moncash?.email || ""}
                              onChange={(e) => handlePaymentGatewayChange('moncash', 'email', e.target.value)}
                              className="bg-white/10 border-white/20 text-white mt-1"
                            />
                          </div>
                          <div>
                            <Label className="text-white/70 text-sm">Instructions</Label>
                            <Textarea
                              placeholder="Send via MonCash to number above"
                              value={formData.payment_gateways?.moncash?.instructions || ""}
                              onChange={(e) => handlePaymentGatewayChange('moncash', 'instructions', e.target.value)}
                              className="bg-white/10 border-white/20 text-white mt-1"
                              rows={2}
                            />
                          </div>
                        </div>
                      </div>

                      {/* Binance Pay */}
                      <div className="bg-white/5 p-4 rounded-lg mb-4">
                        <div className="flex justify-between items-center mb-3">
                          <h4 className="text-white font-semibold flex items-center gap-2">
                            <span>üü°</span> Binance Pay
                          </h4>
                          <label className="flex items-center gap-2">
                            <input 
                              type="checkbox" 
                              checked={formData.payment_gateways?.binance_pay?.enabled || false}
                              onChange={(e) => handlePaymentGatewayChange('binance_pay', 'enabled', e.target.checked)}
                              className="w-4 h-4" 
                            />
                            <span className="text-white text-sm">Enabled</span>
                          </label>
                        </div>
                        <div className="space-y-2">
                          <div>
                            <Label className="text-white/70 text-sm">Binance Pay ID</Label>
                            <Input
                              placeholder="Your Binance Pay ID"
                              value={formData.payment_gateways?.binance_pay?.email || ""}
                              onChange={(e) => handlePaymentGatewayChange('binance_pay', 'email', e.target.value)}
                              className="bg-white/10 border-white/20 text-white mt-1"
                            />
                          </div>
                          <div>
                            <Label className="text-white/70 text-sm">Instructions</Label>
                            <Textarea
                              placeholder="Send via Binance Pay"
                              value={formData.payment_gateways?.binance_pay?.instructions || ""}
                              onChange={(e) => handlePaymentGatewayChange('binance_pay', 'instructions', e.target.value)}
                              className="bg-white/10 border-white/20 text-white mt-1"
                              rows={2}
                            />
                          </div>
                        </div>
                      </div>

                      {/* Zelle */}
                      <div className="bg-white/5 p-4 rounded-lg mb-4">
                        <div className="flex justify-between items-center mb-3">
                          <h4 className="text-white font-semibold flex items-center gap-2">
                            <span>üí≤</span> Zelle
                          </h4>
                          <label className="flex items-center gap-2">
                            <input 
                              type="checkbox" 
                              checked={formData.payment_gateways?.zelle?.enabled || false}
                              onChange={(e) => handlePaymentGatewayChange('zelle', 'enabled', e.target.checked)}
                              className="w-4 h-4" 
                            />
                            <span className="text-white text-sm">Enabled</span>
                          </label>
                        </div>
                        <div className="space-y-2">
                          <div>
                            <Label className="text-white/70 text-sm">Zelle Email/Phone</Label>
                            <Input
                              placeholder="your@email.com or phone"
                              value={formData.payment_gateways?.zelle?.email || ""}
                              onChange={(e) => handlePaymentGatewayChange('zelle', 'email', e.target.value)}
                              className="bg-white/10 border-white/20 text-white mt-1"
                            />
                          </div>
                          <div>
                            <Label className="text-white/70 text-sm">Instructions</Label>
                            <Textarea
                              placeholder="Send via Zelle"
                              value={formData.payment_gateways?.zelle?.instructions || ""}
                              onChange={(e) => handlePaymentGatewayChange('zelle', 'instructions', e.target.value)}
                              className="bg-white/10 border-white/20 text-white mt-1"
                              rows={2}
                            />
                          </div>
                        </div>
                      </div>

                      {/* CashApp */}
                      <div className="bg-white/5 p-4 rounded-lg mb-4">
                        <div className="flex justify-between items-center mb-3">
                          <h4 className="text-white font-semibold flex items-center gap-2">
                            <span>üíµ</span> CashApp
                          </h4>
                          <label className="flex items-center gap-2">
                            <input 
                              type="checkbox" 
                              checked={formData.payment_gateways?.cashapp?.enabled || false}
                              onChange={(e) => handlePaymentGatewayChange('cashapp', 'enabled', e.target.checked)}
                              className="w-4 h-4" 
                            />
                            <span className="text-white text-sm">Enabled</span>
                          </label>
                        </div>
                        <div className="space-y-2">
                          <div>
                            <Label className="text-white/70 text-sm">CashApp Tag</Label>
                            <Input
                              placeholder="$YourCashtag"
                              value={formData.payment_gateways?.cashapp?.email || ""}
                              onChange={(e) => handlePaymentGatewayChange('cashapp', 'email', e.target.value)}
                              className="bg-white/10 border-white/20 text-white mt-1"
                            />
                          </div>
                          <div>
                            <Label className="text-white/70 text-sm">Instructions</Label>
                            <Textarea
                              placeholder="Send via CashApp"
                              value={formData.payment_gateways?.cashapp?.instructions || ""}
                              onChange={(e) => handlePaymentGatewayChange('cashapp', 'instructions', e.target.value)}
                              className="bg-white/10 border-white/20 text-white mt-1"
                              rows={2}
                            />
                          </div>
                        </div>
                      </div>

                      {/* BTC */}
                      <div className="bg-white/5 p-4 rounded-lg mb-4">
                        <div className="flex justify-between items-center mb-3">
                          <h4 className="text-white font-semibold flex items-center gap-2">
                            <span>‚Çø</span> Bitcoin (BTC)
                          </h4>
                          <label className="flex items-center gap-2">
                            <input type="checkbox" defaultChecked className="w-4 h-4" />
                            <span className="text-white text-sm">Enabled</span>
                          </label>
                        </div>
                        <div className="space-y-2">
                          <div>
                            <Label className="text-white/70 text-sm">BTC Wallet Address</Label>
                            <Input
                              placeholder="bc1q..."
                              className="bg-white/10 border-white/20 text-white mt-1"
                            />
                          </div>
                          <div>
                            <Label className="text-white/70 text-sm">Instructions</Label>
                            <Textarea
                              placeholder="Send BTC to the address above"
                              className="bg-white/10 border-white/20 text-white mt-1"
                              rows={2}
                            />
                          </div>
                        </div>
                      </div>

                      {/* USDT Wallets (used by Crypto page fallback + display) */}
                      <div className="bg-white/5 p-4 rounded-lg mb-4">
                        <div className="flex justify-between items-center mb-3">
                          <h4 className="text-white font-semibold flex items-center gap-2">
                            <span>‚ÇÆ</span> USDT (Multiple Chains)
                          </h4>
                        </div>
                        <div className="space-y-3">
                          <div>
                            <Label className="text-white/70 text-sm">BEP20 Wallet (Binance Smart Chain)</Label>
                            <Input
                              placeholder="0x..."
                              className="bg-white/10 border-white/20 text-white mt-1"
                              value={formData.crypto_settings?.wallets?.BEP20 || ''}
                              onChange={(e) => handleCryptoWalletChange('BEP20', e.target.value)}
                            />
                          </div>
                          <div>
                            <Label className="text-white/70 text-sm">TRC20 Wallet (Tron)</Label>
                            <Input
                              placeholder="T..."
                              className="bg-white/10 border-white/20 text-white mt-1"
                              value={formData.crypto_settings?.wallets?.TRC20 || ''}
                              onChange={(e) => handleCryptoWalletChange('TRC20', e.target.value)}
                            />
                          </div>
                          <div>
                            <Label className="text-white/70 text-sm">MATIC Wallet (Polygon)</Label>
                            <Input
                              placeholder="0x..."
                              className="bg-white/10 border-white/20 text-white mt-1"
                              value={formData.crypto_settings?.wallets?.MATIC || ''}
                              onChange={(e) => handleCryptoWalletChange('MATIC', e.target.value)}
                            />
                          </div>
                        </div>
                      </div>

                      {/* Crypto exchange settings */}
                      <div className="bg-white/5 p-4 rounded-lg mb-4">
                        <h4 className="text-white font-semibold mb-3">Crypto Exchange (USDT) Settings</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                            <Label className="text-white/70 text-sm">Buy Rate (USD per 1 USDT)</Label>
                            <Input
                              type="number"
                              step="0.0001"
                              className="bg-white/10 border-white/20 text-white mt-1"
                              value={formData.crypto_settings?.buy_rate_usdt ?? 1.0}
                              onChange={(e) => handleCryptoSettingsChange('buy_rate_usdt', parseFloat(e.target.value))}
                            />
                          </div>
                          <div>
                            <Label className="text-white/70 text-sm">Sell Rate (USD per 1 USDT)</Label>
                            <Input
                              type="number"
                              step="0.0001"
                              className="bg-white/10 border-white/20 text-white mt-1"
                              value={formData.crypto_settings?.sell_rate_usdt ?? 0.98}
                              onChange={(e) => handleCryptoSettingsChange('sell_rate_usdt', parseFloat(e.target.value))}
                            />
                          </div>
                          <div>
                            <Label className="text-white/70 text-sm">Fee %</Label>
                            <Input
                              type="number"
                              step="0.1"
                              className="bg-white/10 border-white/20 text-white mt-1"
                              value={formData.crypto_settings?.transaction_fee_percent ?? 2.0}
                              onChange={(e) => handleCryptoSettingsChange('transaction_fee_percent', parseFloat(e.target.value))}
                            />
                          </div>
                          <div>
                            <Label className="text-white/70 text-sm">Minimum Transaction (USD)</Label>
                            <Input
                              type="number"
                              step="0.01"
                              className="bg-white/10 border-white/20 text-white mt-1"
                              value={formData.crypto_settings?.min_transaction_usd ?? 10.0}
                              onChange={(e) => handleCryptoSettingsChange('min_transaction_usd', parseFloat(e.target.value))}
                            />
                          </div>
                        </div>
                      </div>

                      <Button type="submit" className="w-full bg-white text-purple-600 hover:bg-gray-100">
                        Save Payment Settings
                      </Button>
                    </div>
                    ) : (
                      <div className="text-center text-white/60 py-8">
                        Loading payment gateways...
                      </div>
                    )}
                  </TabsContent>

                  <TabsContent value="email" className="space-y-4">
                    <div>
                      <Label className="text-white text-lg font-semibold mb-3 block">Send Bulk Email</Label>
                      <p className="text-gray-400 text-sm mb-4">Send promotional emails using Resend.com API.</p>
                      
                      <div className="space-y-4">
                        <div>
                          <Label htmlFor="recipient_type" className="text-white">Recipients</Label>
                          <Select value={bulkEmail.recipient_type} onValueChange={(value) => setBulkEmail({...bulkEmail, recipient_type: value})}>
                            <SelectTrigger className="bg-white/10 border-white/20 text-white" data-testid="recipient-select">
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="all">All Users</SelectItem>
                              <SelectItem value="customers">Customers Only</SelectItem>
                            </SelectContent>
                          </Select>
                        </div>

                        <div>
                          <Label htmlFor="email_subject" className="text-white">Subject</Label>
                          <Input
                            id="email_subject"
                            value={bulkEmail.subject}
                            onChange={(e) => setBulkEmail({...bulkEmail, subject: e.target.value})}
                            className="bg-white/10 border-white/20 text-white placeholder:text-gray-500"
                            placeholder="Email subject"
                            data-testid="email-subject-input"
                          />
                        </div>

                        <div>
                          <Label htmlFor="email_message" className="text-white">Message</Label>
                          <Textarea
                            id="email_message"
                            value={bulkEmail.message}
                            onChange={(e) => setBulkEmail({...bulkEmail, message: e.target.value})}
                            className="bg-white/10 border-white/20 text-white placeholder:text-gray-500"
                            placeholder="Your promotional message..."
                            rows={6}
                            data-testid="email-message-input"
                          />
                        </div>

                        <Button
                          type="button"
                          onClick={handleSendBulkEmail}
                          disabled={sendingEmail}
                          className="w-full gradient-button text-white"
                          data-testid="send-email-btn"
                        >
                          <Mail className="mr-2" size={20} />
                          {sendingEmail ? 'Sending...' : 'Send Bulk Email'}
                        </Button>

                        <div className="p-4 bg-yellow-400/10 border border-yellow-400/30 rounded-lg">
                          <p className="text-yellow-200 text-sm">
                            <strong>Note:</strong> Configure Resend API key in API Keys tab first.
                          </p>
                        </div>
                      </div>
                    </div>
                  </TabsContent>

                  <div className="mt-6 pt-6 border-t border-white/20">
                    <Button
                      type="submit"
                      disabled={loading}
                      className="w-full gradient-button text-white py-6 text-lg"
                      data-testid="save-settings-btn"
                    >
                      <Save className="mr-2" size={20} />
                      {loading ? 'Saving...' : 'Save Settings'}
                    </Button>
                  </div>
                </form>
              </Tabs>
            </CardContent>
          </Card>
        </div>
      </div>

      <Footer settings={currentSettings} />
    </div>
  );
};

export default AdminSettings;
